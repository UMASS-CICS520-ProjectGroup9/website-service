{% extends '../../base_components/main.html' %}
{% load static %}

{% block content %}
<div class="single">
    <!-- Main -->
    <div id="main">
        {% if discussion %}
        <article class="post">
            <header>
                <div class="title">
                    <h2>{{ discussion.title }}</h2>
                    <p>Discussion for {{ course_subject }} {{ course_id }}</p>
                </div>
                <div class="meta">
                    <!-- prettier-ignore -->
                    <time class="published" datetime="{{ discussion.created_at }}">{{ discussion.created_at_display}}</time>
                    <a href="#" class="author"><span class="name">{{ discussion.author }}</span><img
                            src="{% static 'images/avatar.jpg' %}" alt="" /></a>
                </div>
            </header>
            <p>{{ discussion.body }}</p>
        </article>

        <hr style="margin: 2.5rem 0; border: none; border-top: 1px solid #eee;" />
        <section>
            <h3 style="font-size:1.8rem; margin-bottom:1.2rem; font-weight:700;">Comments ({{ comments|length }})</h3>
            {% if comments %}
            <ul style="list-style:none; padding:0; margin:0; display:grid; gap:1.25rem;">
                {% for comment in comments %}
                <li style="background:#fafafa; border:1px solid #e5e5e5; border-radius:8px; padding:1rem 1.2rem;">
                    <div
                        style="font-size:0.9rem; color:#777; margin-bottom:0.4rem; display:flex; justify-content:space-between; align-items:center;">
                        <span>
                            <strong>{{ comment.author }}</strong>
                            <span style="color:#bbb">&middot;</span>
                            <span>{{ comment.created_at_display|default:'Just now' }}</span>
                        </span>
                        {% if user_id|stringformat:'s' == comment.creator_id|stringformat:'s' or role|upper == 'ADMIN' %}
                        <form method="post"
                            action="{% url 'remove_course_comment' course_subject=course_subject course_id=course_id id=comment.id %}"
                            style="display:inline; margin:0;">
                            {% csrf_token %}
                            <button type="submit" class="button small"
                                onclick="return confirm('Delete this comment?');">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                    <div style="font-size:1.05rem; line-height:1.55;">{{ comment.body }}</div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="color:#888; font-style:italic;">No comments yet. Be the first to comment.</p>
            {% endif %}
        </section>
        <hr style="margin: 2.5rem 0; border: none; border-top: 1px solid #eee;" />
        <section>
            <h3 style="font-size:1.6rem; margin-bottom:1rem; font-weight:700;">Add a comment</h3>
            <form method="post"
                action="{% url 'course_comment_create' course_subject=course_subject course_id=course_id %}">
                {% csrf_token %}
                <input type="hidden" name="discussion_id" value="{{ discussion.id }}">
                <div class="fields" style="display:flex; gap:1rem; align-items:flex-start; margin-bottom:1rem;">
                    <input name="author" placeholder="Your name"
                        style="flex:0 0 200px; padding:0.8rem; border:1px solid #e5e5e5; border-radius:4px;" />
                    <textarea name="body" placeholder="Write your comment..." rows="1"
                        style="flex:1; padding:0.8rem; border:1px solid #e5e5e5; border-radius:4px;"></textarea>
                </div>
                <ul class="actions">
                    <li><input type="submit" value="Post" class="primary"></li>
                </ul>
            </form>
        </section>

        {% else %}
        <article class="post">
            <header>
                <div class="title">
                    <h2>No Discussion Found</h2>
                    <p>There is no discussion for {{ course_subject }} {{ course_id }} yet.</p>
                </div>
            </header>
            <p>Be the first to start the conversation!</p>
        </article>
        {% endif %}
    </div>
</div>
{% endblock %}