{% load static %}
<!-- Main -->
<div id="main">
  <!-- Scroll target for pagination -->
  <div id="events-section"></div>

  <!-- Post -->
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="events">Top Events</a></h2>
        <p>Events, Meeting, and Posts By Students Recently</p>
      </div>
    </header>
    <div id="event-container" hx-get="/events/page/1/" hx-trigger="load" hx-target="#event-container" hx-swap="innerHTML"></div>

    <!-- Page Button -->
    <div id="event-pagination" style="text-align:center; margin-top:20px;">
      <button id="prev-btn" disabled>Previous</button>
      <button id="next-btn">Next</button>
    </div>
  </article>

  {% if request.session.role == 'ADMIN' or request.session.role == 'STUDENT' %}
  <!-- Scroll target for discussion pagination -->
  <div id="discussions-section"></div>

  <article class="post">
    <header>
      <div class="title">
        <h2><a href="discussions">Discussion & Topics</a></h2>
        <p>Recent Updates Discussions and Topics by Students</p>
      </div>
    </header>

    <div class="content">
      <!-- HTMX will load table here -->
      <div id="discussion-container" hx-get="/dashboard-discussions/page/1/" hx-trigger="load" hx-target="#discussion-container" hx-swap="innerHTML"></div>
    </div>

    <div id="discussion-pagination" style="text-align:center; margin-top:20px;">
      <button id="d-prev-btn" disabled>Previous</button>
      <button id="d-next-btn">Next</button>
    </div>
  </article>
  {% endif %}

  <!-- Pagination -->
  {# {% include '../../components/pagination.html' %} #}

  {# <button hx-get="/home/get/" hx-target="#item-list" hx-swap="outerHTML">Load Items</button> #}
  {# <div id="item-list"></div> #}
</div>

<script>
  function updateDiscussionButtons() {
    const info = document.querySelector('#discussion-page-info')
    const pagination = document.getElementById('discussion-pagination')

    if (!info || !pagination) return;

    let current = parseInt(info.dataset.currentPage)
    let total = parseInt(info.dataset.totalPages)

    pagination.style.display = total <= 1 ? 'none' : 'block'

    const prevBtn = document.getElementById('d-prev-btn')
    const nextBtn = document.getElementById('d-next-btn')

    if (prevBtn && nextBtn) {
      prevBtn.disabled = current <= 1
      nextBtn.disabled = current >= total
    }
  }

  document.body.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail.target.id === 'discussion-container') {
      updateDiscussionButtons()
    }
  })

  // NEXT (discussion)
  const dNext = document.getElementById('d-next-btn')
  if (dNext) {
    dNext.addEventListener('click', function () {
      const info = document.querySelector('#discussion-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)
      let total = parseInt(info.dataset.totalPages)

      if (current < total) {
        htmx.ajax('GET', `/dashboard-discussions/page/${current + 1}/`, {
          target: '#discussion-container',
          swap: 'innerHTML'
        }).then(() => {
          updateDiscussionButtons()
          scrollToDiscussions()
        })
      }
    })
  }

  // PREVIOUS (discussion)
  const dPrev = document.getElementById('d-prev-btn')
  if (dPrev) {
    dPrev.addEventListener('click', function () {
      const info = document.querySelector('#discussion-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)

      if (current > 1) {
        htmx.ajax('GET', `/dashboard-discussions/page/${current - 1}/`, {
          target: '#discussion-container',
          swap: 'innerHTML'
        }).then(() => {
          updateDiscussionButtons()
          scrollToDiscussions()
        })
      }
    })
  }

  function scrollToDiscussions() {
    const discussionsSection = document.querySelector('#discussions-section')
    if (discussionsSection) {
      discussionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
    }
  }

  document.addEventListener('DOMContentLoaded', updateDiscussionButtons)

  // -----------------------------
  // EVENT PAGINATION (SAFE)
  // -----------------

// -----------------------------
  // EVENT PAGINATION (SAFE)
  // -----------------------------
  function updateEventPageButtons() {
    const info = document.querySelector('#event-page-info')
    const pagination = document.getElementById('event-pagination')

    if (!info || !pagination) return;

    let current = parseInt(info.dataset.currentPage)
    let total = parseInt(info.dataset.totalPages)

    pagination.style.display = total <= 1 ? 'none' : 'block'

    const prev = document.getElementById('prev-btn')
    const next = document.getElementById('next-btn')

    if (prev && next) {
      prev.disabled = current <= 1
      next.disabled = current >= total
    }
  }

  document.body.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail.target.id === 'event-container') {
      updateEventPageButtons()
    }
  })

  // NEXT (events)
  const eNext = document.getElementById('next-btn')
  if (eNext) {
    eNext.addEventListener('click', function () {
      const info = document.querySelector('#event-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)
      let total = parseInt(info.dataset.totalPages)

      if (current < total) {
        htmx.ajax('GET', `/events/page/${current + 1}/`, {
          target: '#event-container',
          swap: 'innerHTML'
        }).then(() => {
          updateEventPageButtons()
          scrollToEvents()
        })
      }
    })
  }

  // PREVIOUS (events)
  const ePrev = document.getElementById('prev-btn')
  if (ePrev) {
    ePrev.addEventListener('click', function () {
      const info = document.querySelector('#event-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)

      if (current > 1) {
        htmx.ajax('GET', `/events/page/${current - 1}/`, {
          target: '#event-container',
          swap: 'innerHTML'
        }).then(() => {
          updateEventPageButtons()
          scrollToEvents()
        })
      }
    })
  }

  function scrollToEvents() {
    const eventsSection = document.querySelector('#events-section')
    if (eventsSection) {
      eventsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
    }
  }

  document.addEventListener('DOMContentLoaded', updateEventPageButtons)
</script>