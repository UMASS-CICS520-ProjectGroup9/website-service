{% load static %}
<!-- Main -->
<div id="main">
  <!-- Scroll target for pagination -->
  <div id="events-section"></div>

  <!-- Post -->
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="events">Top Events</a></h2>
        <p>Events, Meeting, and Posts By Students Recently</p>
      </div>
    </header>
    <div id="event-container" hx-get="/events/page/1/" hx-trigger="load" hx-target="#event-container" hx-swap="innerHTML"></div>

    <!-- Page Button -->
    <div id="event-pagination" style="text-align:center; margin-top:20px;">
      <button id="prev-btn" disabled>Previous</button>
      <button id="next-btn">Next</button>
    </div>
  </article>

  {% if request.session.role == 'ADMIN' or request.session.role == 'STUDENT' %}
  <!-- Scroll target for discussion pagination -->
  <div id="discussions-section"></div>

  <article class="post">
    <header>
      <div class="title">
        <h2><a href="discussions">Discussion & Topics</a></h2>
        <p>Recent Updates Discussions and Topics by Students</p>
      </div>
    </header>

    <div class="content">
      <!-- HTMX will load table here -->
      <div id="discussion-container" hx-get="/dashboard-discussions/page/1/" hx-trigger="load" hx-target="#discussion-container" hx-swap="innerHTML"></div>
    </div>

    <div id="discussion-pagination" style="text-align:center; margin-top:20px;">
      <button id="d-prev-btn" disabled>Previous</button>
      <button id="d-next-btn">Next</button>
    </div>
  </article>
  {% endif %}

  <!-- Pagination -->
  {# {% include '../../components/pagination.html' %} #}

  {# <button hx-get="/home/get/" hx-target="#item-list" hx-swap="outerHTML">Load Items</button> #}
  {# <div id="item-list"></div> #}
</div>

<script>
  // ==========================================
  // SECTION 1: DISCUSSION PAGINATION LOGIC
  // ==========================================

  /**
   * Updates the state (enabled/disabled) of discussion pagination buttons
   * based on the current page and total pages.
   */
  function updateDiscussionButtons() {
    const info = document.querySelector('#discussion-page-info')
    const pagination = document.getElementById('discussion-pagination')

    // Safety check: ensure elements exist
    if (!info || !pagination) return;

    // Parse current page and total pages from data attributes
    let current = parseInt(info.dataset.currentPage)
    let total = parseInt(info.dataset.totalPages)

    // Hide pagination controls if there is only 1 page
    pagination.style.display = total <= 1 ? 'none' : 'block'

    const prevBtn = document.getElementById('d-prev-btn')
    const nextBtn = document.getElementById('d-next-btn')

    // Disable 'Previous' on page 1, disable 'Next' on the last page
    if (prevBtn && nextBtn) {
      prevBtn.disabled = current <= 1
      nextBtn.disabled = current >= total
    }
  }

  // Event Listener: Re-evaluate button states after HTMX loads new content
  document.body.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail.target.id === 'discussion-container') {
      updateDiscussionButtons()
    }
  })

  // -----------------------------
  // DISCUSSION: NEXT BUTTON
  // -----------------------------
  const dNext = document.getElementById('d-next-btn')
  if (dNext) {
    dNext.addEventListener('click', function () {
      const info = document.querySelector('#discussion-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)
      let total = parseInt(info.dataset.totalPages)

      // If not on the last page, load the next page via HTMX
      if (current < total) {
        htmx.ajax('GET', `/dashboard-discussions/page/${current + 1}/`, {
          target: '#discussion-container',
          swap: 'innerHTML'
        }).then(() => {
          updateDiscussionButtons() // Update buttons after load
          scrollToDiscussions()     // Scroll back to top of section
        })
      }
    })
  }

  // -----------------------------
  // DISCUSSION: PREVIOUS BUTTON
  // -----------------------------
  const dPrev = document.getElementById('d-prev-btn')
  if (dPrev) {
    dPrev.addEventListener('click', function () {
      const info = document.querySelector('#discussion-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)

      // If not on the first page, load the previous page via HTMX
      if (current > 1) {
        htmx.ajax('GET', `/dashboard-discussions/page/${current - 1}/`, {
          target: '#discussion-container',
          swap: 'innerHTML'
        }).then(() => {
          updateDiscussionButtons()
          scrollToDiscussions()
        })
      }
    })
  }

  // Helper function to smooth scroll back to the discussion section
  function scrollToDiscussions() {
    const discussionsSection = document.querySelector('#discussions-section')
    if (discussionsSection) {
      discussionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
    }
  }

  // Initialize buttons when the page first loads
  document.addEventListener('DOMContentLoaded', updateDiscussionButtons)


  // ==========================================
  // SECTION 2: EVENT PAGINATION LOGIC
  // ==========================================

  /**
   * Updates the state of event pagination buttons.
   * Logic is identical to discussion buttons but targets event IDs.
   */
  function updateEventPageButtons() {
    const info = document.querySelector('#event-page-info')
    const pagination = document.getElementById('event-pagination')

    if (!info || !pagination) return;

    let current = parseInt(info.dataset.currentPage)
    let total = parseInt(info.dataset.totalPages)

    // Hide if only 1 page exists
    pagination.style.display = total <= 1 ? 'none' : 'block'

    const prev = document.getElementById('prev-btn')
    const next = document.getElementById('next-btn')

    if (prev && next) {
      prev.disabled = current <= 1
      next.disabled = current >= total
    }
  }

  // Re-evaluate event buttons after HTMX swap
  document.body.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail.target.id === 'event-container') {
      updateEventPageButtons()
    }
  })

  // -----------------------------
  // EVENTS: NEXT BUTTON
  // -----------------------------
  const eNext = document.getElementById('next-btn')
  if (eNext) {
    eNext.addEventListener('click', function () {
      const info = document.querySelector('#event-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)
      let total = parseInt(info.dataset.totalPages)

      // Fetch next event page
      if (current < total) {
        htmx.ajax('GET', `/events/page/${current + 1}/`, {
          target: '#event-container',
          swap: 'innerHTML'
        }).then(() => {
          updateEventPageButtons()
          scrollToEvents()
        })
      }
    })
  }

  // -----------------------------
  // EVENTS: PREVIOUS BUTTON
  // -----------------------------
  const ePrev = document.getElementById('prev-btn')
  if (ePrev) {
    ePrev.addEventListener('click', function () {
      const info = document.querySelector('#event-page-info')
      if (!info) return;

      let current = parseInt(info.dataset.currentPage)

      // Fetch previous event page
      if (current > 1) {
        htmx.ajax('GET', `/events/page/${current - 1}/`, {
          target: '#event-container',
          swap: 'innerHTML'
        }).then(() => {
          updateEventPageButtons()
          scrollToEvents()
        })
      }
    })
  }

  // Helper function to smooth scroll back to the events section
  function scrollToEvents() {
    const eventsSection = document.querySelector('#events-section')
    if (eventsSection) {
      eventsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
    }
  }

  // Initialize event buttons on load
  document.addEventListener('DOMContentLoaded', updateEventPageButtons)
</script>